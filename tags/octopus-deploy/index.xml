<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Octopus Deploy | Sujith Quintelier</title>
    <link>/tags/octopus-deploy/</link>
      <atom:link href="/tags/octopus-deploy/index.xml" rel="self" type="application/rss+xml" />
    <description>Octopus Deploy</description>
    <generator>Source Themes Academic (https://sourcethemes.com/academic/)</generator><language>en-us</language><copyright>Â©2019</copyright><lastBuildDate>Fri, 22 Jun 2018 10:00:00 +0000</lastBuildDate>
    <image>
      <url>/img/Quintelier_Sujith</url>
      <title>Octopus Deploy</title>
      <link>/tags/octopus-deploy/</link>
    </image>
    
    <item>
      <title>Create, build and deploy Azure Functions with Visual Studio, Teamcity and Octopus Deploy</title>
      <link>/post/createbuildazfvstcod/</link>
      <pubDate>Fri, 22 Jun 2018 10:00:00 +0000</pubDate>
      <guid>/post/createbuildazfvstcod/</guid>
      <description>

&lt;p&gt;Following this note you will be able to Create, Build and Deploy a simple Azure Function App. You create it in Visual Studio. Let it build with Teamcity and deploy it with Octopus Deploy. The needed Azure Resources will also be deployed.&lt;/p&gt;

&lt;h1 id=&#34;setup&#34;&gt;Setup&lt;/h1&gt;

&lt;h2 id=&#34;tools&#34;&gt;Tools&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Visual Studio 2017 v15.7.4 (VS).&lt;/li&gt;
&lt;li&gt;TeamCity v2017.2.4 (TC).&lt;/li&gt;
&lt;li&gt;Octopus Deploy v2018.6.2 (OD).&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;For this purpose I deployed a Azure VM using this &lt;a href=&#34;https://portal.azure.com/#create/octopus.octopusdeployoctopus-deploy&#34; target=&#34;_blank&#34;&gt;template&lt;/a&gt;, installed an OD Tentacle, a TC Agent and OD cli (in &lt;code&gt;C:\Programs\Octo&lt;/code&gt;). OD downloads can be found &lt;a href=&#34;https://octopus.com/downloads&#34; target=&#34;_blank&#34;&gt;here&lt;/a&gt;. Also install the correct .NET version via this &lt;a href=&#34;https://www.microsoft.com/web/downloads/platform.aspx&#34; target=&#34;_blank&#34;&gt;link&lt;/a&gt; and set the DOTNET_HOME environment variable in TC to &lt;code&gt;C:\Program Files\dotnet\&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Make sure you have installed the Azure development workload in VS. Check via TOOLS\Get Tools and Features&amp;hellip;
&lt;img src=&#34;img/ZuinKne.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;On Workloads tab check Azure development&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;img/oojIgPk.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;create&#34;&gt;Create&lt;/h1&gt;

&lt;p&gt;We use VS for developing the Function. Store the project in a source control system supported by TC.&lt;/p&gt;

&lt;h2 id=&#34;function&#34;&gt;Function&lt;/h2&gt;

&lt;p&gt;Add new Project, search for Azure Functions and give it a name. It is a basic http trigger. Nothing fancy. Modify if needed.&lt;/p&gt;

&lt;p&gt;Install Nuget package &lt;code&gt;Microsoft.NET.Sdk.Functions&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&#34;arm-template&#34;&gt;ARM Template&lt;/h2&gt;

&lt;p&gt;Deploying an Azure Function needs 3 Azure Resources:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Storage Account (Microsoft.Storage/storageAccounts)&lt;/li&gt;
&lt;li&gt;Hosting Plan (Microsoft.We&lt;span&gt;b/serverfarms)&lt;/li&gt;
&lt;li&gt;Function App (Microsoft.We&lt;span&gt;b/sites)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Below you will find a basic ARM Template with these 3 resources and a parameters Template. Set Copy to Output Directory to &lt;code&gt;Copy if Newer&lt;/code&gt;. Add those templates to your project and name them azuredeploy.json and azuredeploy.parameters.json.&lt;/p&gt;

&lt;p&gt;The project structure should look like&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;img/2yV3WSe.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;template&#34;&gt;Template&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-json&#34;&gt;    {
      &amp;quot;$schema&amp;quot;: &amp;quot;https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#&amp;quot;,
      &amp;quot;contentVersion&amp;quot;: &amp;quot;1.0.0.0&amp;quot;,
      &amp;quot;parameters&amp;quot;: {
        &amp;quot;appName&amp;quot;: {
          &amp;quot;type&amp;quot;: &amp;quot;string&amp;quot;,
          &amp;quot;metadata&amp;quot;: {
            &amp;quot;description&amp;quot;: &amp;quot;The name of the function app that you wish to create.&amp;quot;
          }
        },
        &amp;quot;sku&amp;quot;: {
          &amp;quot;type&amp;quot;: &amp;quot;string&amp;quot;,
          &amp;quot;allowedValues&amp;quot;: [
            &amp;quot;Free&amp;quot;,
            &amp;quot;Shared&amp;quot;,
            &amp;quot;Basic&amp;quot;,
            &amp;quot;Standard&amp;quot;
          ],
          &amp;quot;defaultValue&amp;quot;: &amp;quot;Standard&amp;quot;,
          &amp;quot;metadata&amp;quot;: {
            &amp;quot;description&amp;quot;: &amp;quot;The pricing tier for the hosting plan.&amp;quot;
          }
        },
        &amp;quot;workerSize&amp;quot;: {
          &amp;quot;type&amp;quot;: &amp;quot;string&amp;quot;,
          &amp;quot;allowedValues&amp;quot;: [
            &amp;quot;0&amp;quot;,
            &amp;quot;1&amp;quot;,
            &amp;quot;2&amp;quot;
          ],
          &amp;quot;defaultValue&amp;quot;: &amp;quot;0&amp;quot;,
          &amp;quot;metadata&amp;quot;: {
            &amp;quot;description&amp;quot;: &amp;quot;The instance size of the hosting plan (small, medium, or large).&amp;quot;
          }
        },
        &amp;quot;storageAccountType&amp;quot;: {
          &amp;quot;type&amp;quot;: &amp;quot;string&amp;quot;,
          &amp;quot;defaultValue&amp;quot;: &amp;quot;Standard_LRS&amp;quot;,
          &amp;quot;allowedValues&amp;quot;: [
            &amp;quot;Standard_LRS&amp;quot;,
            &amp;quot;Standard_GRS&amp;quot;,
            &amp;quot;Standard_RAGRS&amp;quot;
          ],
          &amp;quot;metadata&amp;quot;: {
            &amp;quot;description&amp;quot;: &amp;quot;Storage Account type&amp;quot;
          }
        },
        &amp;quot;location&amp;quot;: {
          &amp;quot;type&amp;quot;: &amp;quot;string&amp;quot;,
          &amp;quot;defaultValue&amp;quot;: &amp;quot;[resourceGroup().location]&amp;quot;,
          &amp;quot;metadata&amp;quot;: {
            &amp;quot;description&amp;quot;: &amp;quot;Location for all resources.&amp;quot;
          }
        }
      },
      &amp;quot;variables&amp;quot;: {
        &amp;quot;functionAppName&amp;quot;: &amp;quot;[parameters(&#39;appName&#39;)]&amp;quot;,
        &amp;quot;hostingPlanName&amp;quot;: &amp;quot;[parameters(&#39;appName&#39;)]&amp;quot;,
        &amp;quot;storageAccountName&amp;quot;: &amp;quot;[concat(uniquestring(resourceGroup().id), &#39;functions&#39;)]&amp;quot;
      },
      &amp;quot;resources&amp;quot;: [
        {
          &amp;quot;type&amp;quot;: &amp;quot;Microsoft.Storage/storageAccounts&amp;quot;,
          &amp;quot;name&amp;quot;: &amp;quot;[variables(&#39;storageAccountName&#39;)]&amp;quot;,
          &amp;quot;apiVersion&amp;quot;: &amp;quot;2016-12-01&amp;quot;,
          &amp;quot;location&amp;quot;: &amp;quot;[parameters(&#39;location&#39;)]&amp;quot;,
          &amp;quot;kind&amp;quot;: &amp;quot;Storage&amp;quot;,
          &amp;quot;sku&amp;quot;: {
            &amp;quot;name&amp;quot;: &amp;quot;[parameters(&#39;storageAccountType&#39;)]&amp;quot;
          }
        },
        {
          &amp;quot;type&amp;quot;: &amp;quot;Microsoft.Web/serverfarms&amp;quot;,
          &amp;quot;apiVersion&amp;quot;: &amp;quot;2015-04-01&amp;quot;,
          &amp;quot;name&amp;quot;: &amp;quot;[variables(&#39;hostingPlanName&#39;)]&amp;quot;,
          &amp;quot;location&amp;quot;: &amp;quot;[parameters(&#39;location&#39;)]&amp;quot;,
          &amp;quot;properties&amp;quot;: {
            &amp;quot;name&amp;quot;: &amp;quot;[variables(&#39;hostingPlanName&#39;)]&amp;quot;,
            &amp;quot;sku&amp;quot;: &amp;quot;[parameters(&#39;sku&#39;)]&amp;quot;,
            &amp;quot;workerSize&amp;quot;: &amp;quot;[parameters(&#39;workerSize&#39;)]&amp;quot;,
            &amp;quot;hostingEnvironment&amp;quot;: &amp;quot;&amp;quot;,
            &amp;quot;numberOfWorkers&amp;quot;: 1
          }
        },
        {
          &amp;quot;apiVersion&amp;quot;: &amp;quot;2015-04-01&amp;quot;,
          &amp;quot;type&amp;quot;: &amp;quot;Microsoft.Web/sites&amp;quot;,
          &amp;quot;name&amp;quot;: &amp;quot;[variables(&#39;functionAppName&#39;)]&amp;quot;,
          &amp;quot;location&amp;quot;: &amp;quot;[parameters(&#39;location&#39;)]&amp;quot;,
          &amp;quot;kind&amp;quot;: &amp;quot;functionapp&amp;quot;,
          &amp;quot;properties&amp;quot;: {
            &amp;quot;name&amp;quot;: &amp;quot;[variables(&#39;functionAppName&#39;)]&amp;quot;,
            &amp;quot;serverFarmId&amp;quot;: &amp;quot;[resourceId(&#39;Microsoft.Web/serverfarms&#39;, variables(&#39;hostingPlanName&#39;))]&amp;quot;,
            &amp;quot;hostingEnvironment&amp;quot;: &amp;quot;&amp;quot;,
            &amp;quot;clientAffinityEnabled&amp;quot;: false,
            &amp;quot;siteConfig&amp;quot;: {
              &amp;quot;alwaysOn&amp;quot;: true
            }
          },
          &amp;quot;dependsOn&amp;quot;: [
            &amp;quot;[resourceId(&#39;Microsoft.Web/serverfarms&#39;, variables(&#39;hostingPlanName&#39;))]&amp;quot;,
            &amp;quot;[resourceId(&#39;Microsoft.Storage/storageAccounts&#39;, variables(&#39;storageAccountName&#39;))]&amp;quot;
          ],
          &amp;quot;resources&amp;quot;: [
            {
              &amp;quot;apiVersion&amp;quot;: &amp;quot;2016-03-01&amp;quot;,
              &amp;quot;name&amp;quot;: &amp;quot;appsettings&amp;quot;,
              &amp;quot;type&amp;quot;: &amp;quot;config&amp;quot;,
              &amp;quot;dependsOn&amp;quot;: [
                &amp;quot;[resourceId(&#39;Microsoft.Web/sites&#39;, variables(&#39;functionAppName&#39;))]&amp;quot;,
                &amp;quot;[resourceId(&#39;Microsoft.Storage/storageAccounts&#39;, variables(&#39;storageAccountName&#39;))]&amp;quot;
              ],
              &amp;quot;properties&amp;quot;: {
                &amp;quot;AzureWebJobsStorage&amp;quot;: &amp;quot;[concat(&#39;DefaultEndpointsProtocol=https;AccountName=&#39;,variables(&#39;storageAccountName&#39;),&#39;;    AccountKey=&#39;,listkeys(resourceId(&#39;Microsoft.Storage/storageAccounts&#39;, variables(&#39;storageAccountName&#39;)),     &#39;2015-05-01-preview&#39;).key1,&#39;;&#39;)]&amp;quot;,
                &amp;quot;AzureWebJobsDashboard&amp;quot;: &amp;quot;[concat(&#39;DefaultEndpointsProtocol=https;AccountName=&#39;,variables(&#39;storageAccountName&#39;),&#39;;    AccountKey=&#39;,listkeys(resourceId(&#39;Microsoft.Storage/storageAccounts&#39;, variables(&#39;storageAccountName&#39;)),     &#39;2015-05-01-preview&#39;).key1,&#39;;&#39;)]&amp;quot;,
                &amp;quot;FUNCTIONS_EXTENSION_VERSION&amp;quot;: &amp;quot;~1&amp;quot;
              }
            }
          ]
        }
      ]
    }
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;parameters&#34;&gt;Parameters&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-json&#34;&gt;    {
      &amp;quot;$schema&amp;quot;: &amp;quot;https://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#&amp;quot;,
      &amp;quot;contentVersion&amp;quot;: &amp;quot;1.0.0.0&amp;quot;,
      &amp;quot;parameters&amp;quot;: {
        &amp;quot;appName&amp;quot;: {
          &amp;quot;value&amp;quot;: &amp;quot;#{AzureFunctionName}&amp;quot;
        }
      }
    }
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;build&#34;&gt;Build&lt;/h1&gt;

&lt;p&gt;In TC Create a new project, add a new Build Configuration with 3 Build Steps.&lt;/p&gt;

&lt;h2 id=&#34;parameters-1&#34;&gt;Parameters&lt;/h2&gt;

&lt;p&gt;These are use in TC in scripts, variable names, &amp;hellip;
* apikey (generated in OD)
* packageId (&lt;code&gt;tc-od&lt;/code&gt;)
* server (url to OD)
* version (semantic version nr like &lt;code&gt;1.0.%build.number%&lt;/code&gt;)&lt;/p&gt;

&lt;h2 id=&#34;publish&#34;&gt;publish&lt;/h2&gt;

&lt;p&gt;This runner type is .NET CLI (dotnet). Give a Step name. Choose publish as Command. Select the project. Set Configuration and Output directory to bin\Release\PublishOutput
&lt;img src=&#34;img/bsGq2cx.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;pack&#34;&gt;pack&lt;/h2&gt;

&lt;p&gt;This runner type is Command Line. Give a Step name. Choose Custom script and enter script below.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-batch&#34;&gt;cd tc-od\bin\Release\PublishOutput
C:\Programs\Octo\octo pack --id=%packageId% --format=zip --outFolder=../dist --version=%version%
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;push&#34;&gt;push&lt;/h2&gt;

&lt;p&gt;This runner type is Command Line. Give a Step name. Choose Custom script and enter script below.&lt;/p&gt;

&lt;p&gt;This pushed the zip file to OD.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-batch&#34;&gt;cd tc-od\bin\Release\dist
C:\Programs\Octo\octo push --server=%server% --apiKey=%apikey% --package=%packageId%.%version%.zip
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;deploy&#34;&gt;Deploy&lt;/h1&gt;

&lt;p&gt;In OD make sure you have setup&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;an Environment&lt;/li&gt;
&lt;li&gt;a Deployment target(in our case a Azure Web App)&lt;/li&gt;
&lt;li&gt;a Lifecycle with automatic deploy after release creation&lt;/li&gt;
&lt;li&gt;an Azure Subscription (this is needed to deploy)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Add a project.&lt;/p&gt;

&lt;p&gt;Under Process add 2 steps:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Deploy Resources&lt;/li&gt;
&lt;li&gt;Deploy Function&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;deploy-resources&#34;&gt;Deploy Resources&lt;/h2&gt;

&lt;p&gt;In this step we deploy the ARM template.&lt;/p&gt;

&lt;p&gt;Search for &lt;code&gt;resource Group&lt;/code&gt; and select Deploy an Azure resource Group.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Set Step Name&lt;/li&gt;
&lt;li&gt;Select Execution Plan&lt;/li&gt;
&lt;li&gt;Select an Azure Account and Resource Group&lt;/li&gt;
&lt;li&gt;Select File inside a package&lt;/li&gt;
&lt;li&gt;Select Package&lt;/li&gt;
&lt;li&gt;Set Paths&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;deploy-function&#34;&gt;Deploy Function&lt;/h2&gt;

&lt;p&gt;In this step we deploy the Function.&lt;/p&gt;

&lt;p&gt;Search for &lt;code&gt;azure web&lt;/code&gt; and select Deploy an Azure Web App.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Set Step Name&lt;/li&gt;
&lt;li&gt;Select Package&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This is it. Happy coding!&lt;/p&gt;

&lt;h1 id=&#34;resources&#34;&gt;Resources&lt;/h1&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://octopus.com/blog/azure-functions&#34; target=&#34;_blank&#34;&gt;https://octopus.com/blog/azure-functions&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
  </channel>
</rss>
