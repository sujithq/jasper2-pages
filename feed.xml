<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.6.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2018-09-13T17:17:24+02:00</updated><id>http://localhost:4000/</id><title type="html">Sujith Quintelier’s Blog</title><subtitle>Blog about Azure - .NET - ...</subtitle><entry><title type="html">Create, build and deploy Azure Functions with Visual Studio, Teamcity and Octopus Deploy</title><link href="http://localhost:4000/create-build-and-deploy-azure-functions-with-visual-studio-teamcity-and-octopus-deploy" rel="alternate" type="text/html" title="Create, build and deploy Azure Functions with Visual Studio, Teamcity and Octopus Deploy" /><published>2018-09-13T12:00:00+02:00</published><updated>2018-09-13T12:00:00+02:00</updated><id>http://localhost:4000/create-build-and-deploy-azure-functions-with-visual-studio-teamcity-and-octopus-deploy</id><content type="html" xml:base="http://localhost:4000/create-build-and-deploy-azure-functions-with-visual-studio-teamcity-and-octopus-deploy">&lt;p&gt;Following this note you will be able to Create, Build and Deploy a simple Azure Function App. You create it in Visual Studio. Let it build with Teamcity and deploy it with Octopus Deploy. The needed Azure Resources will also be deployed.&lt;/p&gt;

&lt;h1 id=&quot;setup&quot;&gt;Setup&lt;/h1&gt;
&lt;h2 id=&quot;tools&quot;&gt;Tools&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Visual Studio 2017 v15.7.4 (VS).&lt;/li&gt;
  &lt;li&gt;TeamCity v2017.2.4 (TC).&lt;/li&gt;
  &lt;li&gt;Octopus Deploy v2018.6.2 (OD).&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;For this purpose I deployed a Azure VM using this [template] (https://portal.azure.com/#create/octopus.octopusdeployoctopus-deploy), installed an OD Tentacle, a TC Agent and OD cli (in &lt;code class=&quot;highlighter-rouge&quot;&gt;C:\Programs\Octo&lt;/code&gt;). OD downloads can be found [here] (https://octopus.com/downloads). Also install the correct .NET version via this [link] (https://www.microsoft.com/web/downloads/platform.aspx) and set the DOTNET_HOME environment variable in TC to &lt;code class=&quot;highlighter-rouge&quot;&gt;C:\Program Files\dotnet\&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Make sure you have installed the Azure development workload in VS. Check via TOOLS\Get Tools and Features…
&lt;img src=&quot;assets/images/2018-09-13/ZuinKne.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;On Workloads tab check Azure development&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;assets/images/2018-09-13/oojIgPk.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;create&quot;&gt;Create&lt;/h1&gt;
&lt;p&gt;We use VS for developing the Function. Store the project in a source control system supported by TC.&lt;/p&gt;

&lt;h2 id=&quot;function&quot;&gt;Function&lt;/h2&gt;
&lt;p&gt;Add new Project, search for Azure Functions and give it a name. It is a basic http trigger. Nothing fancy. Modify if needed.&lt;/p&gt;

&lt;p&gt;Install Nuget package &lt;code class=&quot;highlighter-rouge&quot;&gt;Microsoft.NET.Sdk.Functions&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&quot;arm-template&quot;&gt;ARM Template&lt;/h2&gt;
&lt;p&gt;Deploying an Azure Function needs 3 Azure Resources:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Storage Account (Microsoft.Storage/storageAccounts)&lt;/li&gt;
  &lt;li&gt;Hosting Plan (Microsoft.We&lt;span&gt;b/serverfarms)&lt;/span&gt;&lt;/li&gt;
  &lt;li&gt;Function App (Microsoft.We&lt;span&gt;b/sites)&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Below you will find a basic ARM Template with these 3 resources and a parameters Template. Set Copy to Output Directory to &lt;code class=&quot;highlighter-rouge&quot;&gt;Copy if Newer&lt;/code&gt;. Add those templates to your project and name them azuredeploy.json and azuredeploy.parameters.json.&lt;/p&gt;

&lt;p&gt;The project structure should look like&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;assets/images/2018-09-13/2yV3WSe.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;template&quot;&gt;Template&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;{
  &quot;$schema&quot;: &quot;https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#&quot;,
  &quot;contentVersion&quot;: &quot;1.0.0.0&quot;,
  &quot;parameters&quot;: {
    &quot;appName&quot;: {
      &quot;type&quot;: &quot;string&quot;,
      &quot;metadata&quot;: {
        &quot;description&quot;: &quot;The name of the function app that you wish to create.&quot;
      }
    },
    &quot;sku&quot;: {
      &quot;type&quot;: &quot;string&quot;,
      &quot;allowedValues&quot;: [
        &quot;Free&quot;,
        &quot;Shared&quot;,
        &quot;Basic&quot;,
        &quot;Standard&quot;
      ],
      &quot;defaultValue&quot;: &quot;Standard&quot;,
      &quot;metadata&quot;: {
        &quot;description&quot;: &quot;The pricing tier for the hosting plan.&quot;
      }
    },
    &quot;workerSize&quot;: {
      &quot;type&quot;: &quot;string&quot;,
      &quot;allowedValues&quot;: [
        &quot;0&quot;,
        &quot;1&quot;,
        &quot;2&quot;
      ],
      &quot;defaultValue&quot;: &quot;0&quot;,
      &quot;metadata&quot;: {
        &quot;description&quot;: &quot;The instance size of the hosting plan (small, medium, or large).&quot;
      }
    },
    &quot;storageAccountType&quot;: {
      &quot;type&quot;: &quot;string&quot;,
      &quot;defaultValue&quot;: &quot;Standard_LRS&quot;,
      &quot;allowedValues&quot;: [
        &quot;Standard_LRS&quot;,
        &quot;Standard_GRS&quot;,
        &quot;Standard_RAGRS&quot;
      ],
      &quot;metadata&quot;: {
        &quot;description&quot;: &quot;Storage Account type&quot;
      }
    },
    &quot;location&quot;: {
      &quot;type&quot;: &quot;string&quot;,
      &quot;defaultValue&quot;: &quot;[resourceGroup().location]&quot;,
      &quot;metadata&quot;: {
        &quot;description&quot;: &quot;Location for all resources.&quot;
      }
    }
  },
  &quot;variables&quot;: {
    &quot;functionAppName&quot;: &quot;[parameters('appName')]&quot;,
    &quot;hostingPlanName&quot;: &quot;[parameters('appName')]&quot;,
    &quot;storageAccountName&quot;: &quot;[concat(uniquestring(resourceGroup().id), 'functions')]&quot;
  },
  &quot;resources&quot;: [
    {
      &quot;type&quot;: &quot;Microsoft.Storage/storageAccounts&quot;,
      &quot;name&quot;: &quot;[variables('storageAccountName')]&quot;,
      &quot;apiVersion&quot;: &quot;2016-12-01&quot;,
      &quot;location&quot;: &quot;[parameters('location')]&quot;,
      &quot;kind&quot;: &quot;Storage&quot;,
      &quot;sku&quot;: {
        &quot;name&quot;: &quot;[parameters('storageAccountType')]&quot;
      }
    },
    {
      &quot;type&quot;: &quot;Microsoft.Web/serverfarms&quot;,
      &quot;apiVersion&quot;: &quot;2015-04-01&quot;,
      &quot;name&quot;: &quot;[variables('hostingPlanName')]&quot;,
      &quot;location&quot;: &quot;[parameters('location')]&quot;,
      &quot;properties&quot;: {
        &quot;name&quot;: &quot;[variables('hostingPlanName')]&quot;,
        &quot;sku&quot;: &quot;[parameters('sku')]&quot;,
        &quot;workerSize&quot;: &quot;[parameters('workerSize')]&quot;,
        &quot;hostingEnvironment&quot;: &quot;&quot;,
        &quot;numberOfWorkers&quot;: 1
      }
    },
    {
      &quot;apiVersion&quot;: &quot;2015-04-01&quot;,
      &quot;type&quot;: &quot;Microsoft.Web/sites&quot;,
      &quot;name&quot;: &quot;[variables('functionAppName')]&quot;,
      &quot;location&quot;: &quot;[parameters('location')]&quot;,
      &quot;kind&quot;: &quot;functionapp&quot;,
      &quot;properties&quot;: {
        &quot;name&quot;: &quot;[variables('functionAppName')]&quot;,
        &quot;serverFarmId&quot;: &quot;[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]&quot;,
        &quot;hostingEnvironment&quot;: &quot;&quot;,
        &quot;clientAffinityEnabled&quot;: false,
        &quot;siteConfig&quot;: {
          &quot;alwaysOn&quot;: true
        }
      },
      &quot;dependsOn&quot;: [
        &quot;[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]&quot;,
        &quot;[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]&quot;
      ],
      &quot;resources&quot;: [
        {
          &quot;apiVersion&quot;: &quot;2016-03-01&quot;,
          &quot;name&quot;: &quot;appsettings&quot;,
          &quot;type&quot;: &quot;config&quot;,
          &quot;dependsOn&quot;: [
            &quot;[resourceId('Microsoft.Web/sites', variables('functionAppName'))]&quot;,
            &quot;[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]&quot;
          ],
          &quot;properties&quot;: {
            &quot;AzureWebJobsStorage&quot;: &quot;[concat('DefaultEndpointsProtocol=https;AccountName=',variables('storageAccountName'),';    AccountKey=',listkeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),     '2015-05-01-preview').key1,';')]&quot;,
            &quot;AzureWebJobsDashboard&quot;: &quot;[concat('DefaultEndpointsProtocol=https;AccountName=',variables('storageAccountName'),';    AccountKey=',listkeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),     '2015-05-01-preview').key1,';')]&quot;,
            &quot;FUNCTIONS_EXTENSION_VERSION&quot;: &quot;~1&quot;
          }
        }
      ]
    }
  ]
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;parameters&quot;&gt;Parameters&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;{
  &quot;$schema&quot;: &quot;https://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#&quot;,
  &quot;contentVersion&quot;: &quot;1.0.0.0&quot;,
  &quot;parameters&quot;: {
    &quot;appName&quot;: {
      &quot;value&quot;: &quot;#{AzureFunctionName}&quot;
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;build&quot;&gt;Build&lt;/h1&gt;
&lt;p&gt;In TC Create a new project, add a new Build Configuration with 3 Build Steps.&lt;/p&gt;

&lt;h2 id=&quot;parameters-1&quot;&gt;Parameters&lt;/h2&gt;
&lt;p&gt;These are use in TC in scripts, variable names, …&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;apikey (generated in OD)&lt;/li&gt;
  &lt;li&gt;packageId (&lt;code class=&quot;highlighter-rouge&quot;&gt;tc-od&lt;/code&gt;)&lt;/li&gt;
  &lt;li&gt;server (url to OD)&lt;/li&gt;
  &lt;li&gt;version (semantic version nr like &lt;code class=&quot;highlighter-rouge&quot;&gt;1.0.%build.number%&lt;/code&gt;)&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;publish&quot;&gt;publish&lt;/h2&gt;
&lt;p&gt;This runner type is .NET CLI (dotnet). Give a Step name. Choose publish as Command. Select the project. Set Configuration and Output directory to bin\Release\PublishOutput
&lt;img src=&quot;assets/images/2018-09-13/bsGq2cx.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;pack&quot;&gt;pack&lt;/h2&gt;
&lt;p&gt;This runner type is Command Line. Give a Step name. Choose Custom script and enter script below.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cd tc-od\bin\Release\PublishOutput
C:\Programs\Octo\octo pack --id=%packageId% --format=zip --outFolder=../dist --version=%version%
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;push&quot;&gt;push&lt;/h2&gt;
&lt;p&gt;This runner type is Command Line. Give a Step name. Choose Custom script and enter script below.&lt;/p&gt;

&lt;p&gt;This pushed the zip file to OD.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-Batchfile&quot;&gt;cd tc-od\bin\Release\dist
C:\Programs\Octo\octo push --server=%server% --apiKey=%apikey% --package=%packageId%.%version%.zip
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;deploy&quot;&gt;Deploy&lt;/h1&gt;
&lt;p&gt;In OD make sure you have setup&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;an Environment&lt;/li&gt;
  &lt;li&gt;a Deployment target(in our case a Azure Web App)&lt;/li&gt;
  &lt;li&gt;a Lifecycle with automatic deploy after release creation&lt;/li&gt;
  &lt;li&gt;an Azure Subscription (this is needed to deploy)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Add a project.&lt;/p&gt;

&lt;p&gt;Under Process add 2 steps:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Deploy Resources&lt;/li&gt;
  &lt;li&gt;Deploy Function&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;deploy-resources&quot;&gt;Deploy Resources&lt;/h2&gt;
&lt;p&gt;In this step we deploy the ARM template.&lt;/p&gt;

&lt;p&gt;Search for &lt;code class=&quot;highlighter-rouge&quot;&gt;resource Group&lt;/code&gt; and select Deploy an Azure resource Group.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Set Step Name&lt;/li&gt;
  &lt;li&gt;Select Execution Plan&lt;/li&gt;
  &lt;li&gt;Select an Azure Account and Resource Group&lt;/li&gt;
  &lt;li&gt;Select File inside a package&lt;/li&gt;
  &lt;li&gt;Select Package&lt;/li&gt;
  &lt;li&gt;Set Paths&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;deploy-function&quot;&gt;Deploy Function&lt;/h2&gt;
&lt;p&gt;In this step we deploy the Function.&lt;/p&gt;

&lt;p&gt;Search for &lt;code class=&quot;highlighter-rouge&quot;&gt;azure web&lt;/code&gt; and select Deploy an Azure Web App.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Set Step Name&lt;/li&gt;
  &lt;li&gt;Select Package&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This is it. Happy coding!&lt;/p&gt;

&lt;h1 id=&quot;resources&quot;&gt;Resources&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;https://octopus.com/blog/azure-functions&lt;/li&gt;
&lt;/ul&gt;</content><author><name>Sujith Quintelier</name></author><category term="Azure" /><category term="Functions" /><category term="Visual Studio" /><category term="Teamcity" /><category term="Octopus Deploy" /><summary type="html">Following this note you will be able to Create, Build and Deploy a simple Azure Function App. You create it in Visual Studio. Let it build with Teamcity and deploy it with Octopus Deploy. The needed Azure Resources will also be deployed.</summary></entry></feed>